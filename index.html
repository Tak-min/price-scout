<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceScout (v5)</title>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        h1 {
            color: #4A90E2;
            text-align: center;
            margin-bottom: 24px;
        }

        /* æ“ä½œã‚¨ãƒªã‚¢ */
        .controls {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        #imageUploader {
            display: none;
        }

        #uploadLabel {
            display: block;
            background: #4A90E2;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        #uploadLabel:hover {
            background: #3a7ac8;
        }
        #uploadLabel span {
            font-size: 1.5em;
            margin-right: 8px;
        }

        #searchInput {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* paddingã‚’å«ã‚ã¦width 100% */
            margin-top: 16px;
        }
        #searchInput:focus {
            outline: none;
            border-color: #4A90E2;
        }

        /* å•†å“ãƒªã‚¹ãƒˆ */
        #productList {
            margin-top: 16px;
        }

        .product-card {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #50C878; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒœãƒ¼ãƒ€ãƒ¼ */
        }

        .product-card.cheapest {
            border-left-color: #E74C3C; /* æœ€å®‰å€¤ */
        }
        
        .product-card-main {
            flex: 1 1 70%;
        }

        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 16px;
            color: #555;
            margin-bottom: 8px;
        }
        .product-price .unit-price {
            font-size: 18px;
            font-weight: bold;
            color: #4A90E2;
        }
        .product-card.cheapest .unit-price {
            color: #E74C3C;
        }

        .product-meta {
            font-size: 14px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .product-meta .store { font-weight: bold; }
        
        /* ãƒ©ãƒ™ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .product-meta .label {
            background-color: #eee;
            color: #555;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .product-actions {
            flex: 0 0 auto;
            display: flex;
            gap: 8px;
        }

        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            color: #777;
        }
        .delete-button { color: #E74C3C; }
        .edit-button { color: #4A90E2; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #editForm h2 {
            margin-top: 0;
        }

        #editForm label {
            display: block;
            font-weight: bold;
            margin-top: 16px;
            margin-bottom: 6px;
        }

        #editForm input[type="text"],
        #editForm input[type="date"],
        #editForm input[type="number"],
        #editForm select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #itemInputs .item-group {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            background: #f9f9f9;
        }
        
        #itemInputs .item-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        #itemInputs .item-row input[name="name"] {
            grid-column: 1 / -1; /* å•†å“åã¯1è¡Œãƒ•ãƒ« */
        }
        #itemInputs .item-row select[name="label"] {
            grid-column: 1 / -1; /* ã‚«ãƒ†ã‚´ãƒªã‚‚1è¡Œãƒ•ãƒ« */
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        #saveButton, #closeModalButton {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #saveButton {
            background: #50C878;
            color: white;
        }
        #closeModalButton {
            background: #ddd;
            color: #333;
        }

        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ */
        .data-management {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .data-management button {
            flex: 1;
            padding: 10px;
            background: #777;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #importButton { display: none; } /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ä»Šå›ã¯çœç•¥ */

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        #loadingIndicator {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
            color: #4A90E2;
            font-weight: bold;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4A90E2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>PriceScout</h1>

        <div class="controls">
            <label for="imageUploader" id="uploadLabel">
                <span>ğŸ“·</span> ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </label>
            <input type="file" id="imageUploader" accept="image/jpeg, image/png, image/webp">
            
            <input type="text" id="searchInput" placeholder="å•†å“åã‚„ã‚«ãƒ†ã‚´ãƒªåã§æ¤œç´¢...">
        </div>

        <div class="data-management">
            <button id="exportButton">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="importButton" accept=".json">
        </div>

        <div id="productList">
            </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <form id="editForm">
                <h2>ãƒ¬ã‚·ãƒ¼ãƒˆå†…å®¹ã®ç¢ºèªãƒ»ç·¨é›†</h2>
                <input type="hidden" id="editingId">
                
                <label for="store">åº—èˆ—å</label>
                <input type="text" id="store" required>
                
                <label for="date">è³¼å…¥æ—¥</label>
                <input type="date" id="date" required>
                
                <hr style="margin-top: 24px; border: 1px solid #eee;">
                
                <h3>å•†å“ãƒªã‚¹ãƒˆ</h3>
                <div id="itemInputs">
                    </div>
                
                <div class="form-actions">
                    <button type="button" id="closeModalButton">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" id="saveButton">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingIndicator" class="modal">
        <div>
            <div class="loader"></div>
            <p>AIãŒãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æä¸­ã§ã™...</p>
        </div>
    </div>


    <script>
        // ======================================================
        // APIã‚­ãƒ¼è¨­å®š (è¶…é‡è¦)
        // ======================================================
        // 
        // è­¦å‘Š: ã‚ãªãŸã®Gemini APIã‚­ãƒ¼ã‚’ä»¥ä¸‹ã® '...' ã®éƒ¨åˆ†ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
        // ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾ã«ä»–äººã«å…±æœ‰ã—ãŸã‚Šã€Webä¸Šã«å…¬é–‹ã—ãªã„ã§ãã ã•ã„ã€‚
        // 
        const API_KEY = 'AIzaSyCsYqX5sCqc0xMwo4mqvgTlgljncqVp0y0';
        // 
        // ======================================================
        
        // Gemini API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (gemini-2.5-flash-preview-09-2025 v1beta)
        // (JSONãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ v1beta ã‚’ç¶­æŒã—ã€æœ€æ–°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨)
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const STORAGE_KEY = 'priceScoutProducts';

        // â˜…æ–°æ©Ÿèƒ½: å•†å“ã‚«ãƒ†ã‚´ãƒªã®å®šç¾©
        const CATEGORIES = [
            'Produce',      // ç”Ÿé®®é£Ÿå“ (é‡èœãƒ»æœç‰©)
            'Dairy & Eggs', // ä¹³è£½å“ãƒ»åµ
            'Meat & Fish',  // è‚‰ãƒ»é­š
            'Beverages',    // é£²æ–™
            'Frozen',       // å†·å‡é£Ÿå“
            'Pantry',       // ä¿å­˜é£Ÿ (ç±³ã€éººã€ç¼¶è©°ã€èª¿å‘³æ–™)
            'Household',    // æ—¥ç”¨å“ (æ´—å‰¤ã€ç´™é¡)
            'Other'         // ãã®ä»–
        ];

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        const state = {
            products: [], // {id, name, price, quantity, unit, store, date, unitPrice, label}
            searchQuery: '',
            editingId: null, // æ–°è¦ç™»éŒ²ãªã‚‰null, ç·¨é›†ãªã‚‰ID
        };

        // DOMè¦ç´ 
        const imageUploader = document.getElementById('imageUploader');
        const uploadLabel = document.getElementById('uploadLabel');
        const searchInput = document.getElementById('searchInput');
        const productList = document.getElementById('productList');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModalButton = document.getElementById('closeModalButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const storeInput = document.getElementById('store');
        const dateInput = document.getElementById('date');
        const itemInputs = document.getElementById('itemInputs');
        const editingIdInput = document.getElementById('editingId');
        const exportButton = document.getElementById('exportButton');

        // ======================================================
        // åˆæœŸåŒ–å‡¦ç†
        // ======================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Day.jsãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (typeof dayjs === 'undefined') {
                console.error('Day.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            imageUploader.addEventListener('change', handleImageUpload);
            searchInput.addEventListener('input', handleSearch);
            editForm.addEventListener('submit', handleFormSubmit);
            closeModalButton.addEventListener('click', closeModal);
            exportButton.addEventListener('click', exportData);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) closeModal();
            });

            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤º
            loadFromStorage();
            renderProducts();
        });

        // ======================================================
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨AIè§£æ
        // ======================================================
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            e.target.value = null;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            loadingIndicator.style.display = 'flex';

            try {
                // 1. ç”»åƒã‚’Base64ã«å¤‰æ›
                const base64Image = await fileToBase64(file);
                const mimeType = file.type;

                // 2. Gemini APIã‚’å‘¼ã³å‡ºã—
                const geminiResponse = await callGeminiAPI(base64Image, mimeType);
                
                // 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                if (geminiResponse) {
                    showEditModal(geminiResponse, null); // æ–°è¦ç™»éŒ²
                }
            } catch (error) {
                console.error('AIè§£æã‚¨ãƒ©ãƒ¼:', error);
                alert(`AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}\n\nAPIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
                loadingIndicator.style.display = 'none';
            }
        }

        /**
         * Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Base64æ–‡å­—åˆ—ã«å¤‰æ›
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // "data:image/jpeg;base64," ã®éƒ¨åˆ†ã‚’é™¤å»
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Gemini APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æ
         */
        async function callGeminiAPI(base64Image, mimeType) {
            // â˜…å¤‰æ›´: ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹
            const categoryListString = CATEGORIES.join(', ');
            
            const prompt = `
                ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’è§£æã—ã€ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦åº—èˆ—åã€è³¼å…¥æ—¥ã€ãŠã‚ˆã³è³¼å…¥ã—ãŸã™ã¹ã¦ã®å•†å“ãƒªã‚¹ãƒˆï¼ˆå•†å“åã€ä¾¡æ ¼ã€ã‚«ãƒ†ã‚´ãƒªï¼‰ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
                æ—¥ä»˜ã¯å¿…ãš YYYY-MM-DD å½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚
                å•†å“ã¯ "åˆè¨ˆ" ã‚„ "å°è¨ˆ"ã€"å€¤å¼•"ã€"ç¨" ã‚’é™¤ã„ãŸã€å®Ÿéš›ã«è³¼å…¥ã—ãŸå€‹åˆ¥ã®å“ç›®ã®ã¿ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
                å„å•†å“ã®ã‚«ãƒ†ã‚´ãƒªã¯ã€ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„: [${categoryListString}]ã€‚
                ã‚‚ã—ã©ã‚Œã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã¯ 'Other' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            `;

            // â˜…å¤‰æ›´: Gemini API v1beta (gemini-2.5-flash-preview-09-2025) ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
            const requestBody = {
                contents: [
                    {
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                // JSONãƒ¢ãƒ¼ãƒ‰ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            store: { type: "STRING", description: "åº—èˆ—å" },
                            date: { type: "STRING", description: "è³¼å…¥æ—¥ (YYYY-MM-DDå½¢å¼)" },
                            items: {
                                type: "ARRAY",
                                description: "è³¼å…¥ã—ãŸå•†å“ã®ãƒªã‚¹ãƒˆ",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING", description: "å•†å“å" },
                                        price: { type: "NUMBER", description: "ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰" },
                                        // â˜…æ–°æ©Ÿèƒ½: label ã‚’ã‚¹ã‚­ãƒ¼ãƒã«è¿½åŠ 
                                        label: { 
                                            type: "STRING", 
                                            description: `å•†å“ã®ã‚«ãƒ†ã‚´ãƒªã€‚æ¬¡ã®ã„ãšã‚Œã‹: [${categoryListString}]`
                                        }
                                    },
                                    required: ["name", "price", "label"] // labelã‚‚å¿…é ˆã«
                                }
                            }
                        },
                        required: ["store", "date", "items"]
                    }
                }
            };
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error Response:", errorData);
                throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ (${response.status}): ${errorData.error.message}`);
            }

            const data = await response.json();
            
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹ (v1betaä»•æ§˜)
            // candidates[0].content.parts[0].text ã«JSONæ–‡å­—åˆ—ãŒå…¥ã£ã¦ã„ã‚‹
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                try {
                    const jsonData = JSON.parse(data.candidates[0].content.parts[0].text);
                    return jsonData;
                } catch (e) {
                    console.error("ãƒ¬ã‚¹ãƒãƒ³ãƒ³ã‚¹JSONã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—:", e, data.candidates[0].content.parts[0].text);
                    throw new Error("AIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹(JSON)ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
                }
            } else {
                console.error("AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒä¸æ­£:", data);
                throw new Error("AIã‹ã‚‰æœŸå¾…ã—ãŸå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        }

        // ======================================================
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
        // ======================================================

        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
         * @param {object} data - AIã‹ã‚‰ã®è§£æãƒ‡ãƒ¼ã‚¿ (æ–°è¦ç™»éŒ²æ™‚)
         * @param {string} editingId - ç·¨é›†å¯¾è±¡ã®ID (ç·¨é›†æ™‚)
         */
        function showEditModal(data, editingId) {
            editForm.reset();
            itemInputs.innerHTML = '';
            
            if (editingId) {
                // ç·¨é›†ã®å ´åˆ
                const product = state.products.find(p => p.id === editingId);
                if (!product) return;
                
                state.editingId = editingId;
                editingIdInput.value = editingId;
                storeInput.value = product.store;
                dateInput.value = product.date;
                
                // â˜…å¤‰æ›´: 1ã¤ã®å•†å“ã ã‘ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ (labelã‚‚æ¸¡ã™)
                addItemInput(product.name, product.price, product.quantity, product.unit, product.id, product.label);

            } else if (data) {
                // æ–°è¦ç™»éŒ²ã®å ´åˆ (AIãƒ‡ãƒ¼ã‚¿ã‚ã‚Š)
                state.editingId = null;
                editingIdInput.value = '';
                storeInput.value = data.store || '';
                dateInput.value = data.date ? formatDate(data.date, 'YYYY-MM-DD') : formatDate(new Date(), 'YYYY-MM-DD');
                
                // â˜…å¤‰æ›´: AIãŒæŠ½å‡ºã—ãŸã™ã¹ã¦ã®å•†å“ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ (labelã‚‚æ¸¡ã™)
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        // AIãŒå®šç¾©å¤–ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¿”ã—ã¦ããŸå ´åˆ 'Other' ã«è£œæ­£
                        const validLabel = CATEGORIES.includes(item.label) ? item.label : 'Other';
                        addItemInput(item.name, item.price, '', 'g', null, validLabel);
                    });
                } else {
                    // å•†å“ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã‚‚ç©ºã®æ¬„ã‚’1ã¤è¿½åŠ 
                    addItemInput('', '', '', 'g', null, 'Other');
                }
            }
            
            editModal.style.display = 'flex';
        }

        /**
         * â˜…æ–°æ©Ÿèƒ½: ã‚«ãƒ†ã‚´ãƒªã® <option> ã‚¿ã‚°ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹
         */
        function createCategoryOptions(selectedLabel = 'Other') {
            return CATEGORIES.map(category => 
                `<option value="${category}" ${category === selectedLabel ? 'selected' : ''}>${category}</option>`
            ).join('');
        }

        /**
         * å•†å“å…¥åŠ›æ¬„ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¿½åŠ 
         * â˜…å¤‰æ›´: label ã‚’å¼•æ•°ã«è¿½åŠ 
         */
        function addItemInput(name = '', price = '', quantity = '', unit = 'g', id = null, label = 'Other') {
            const newId = id || `new_${Date.now()}_${Math.random()}`;
            
            const group = document.createElement('div');
            group.className = 'item-group';
            group.dataset.id = newId; // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ã“ã®IDã‚’å‚ç…§ã™ã‚‹
            
            group.innerHTML = `
                <input type="hidden" name="id" value="${newId}">
                <div class="item-row">
                    <input type="text" name="name" placeholder="å•†å“å" value="${escapeHTML(name)}" required>
                </div>
                <div class="item-row" style="margin-top: 8px;">
                    <input type="number" name="price" placeholder="ä¾¡æ ¼(å††)" value="${price}" required>
                    <input type="number" name="quantity" placeholder="å†…å®¹é‡" value="${quantity}">
                </div>
                <div class="item-row" style="margin-top: 8px;">
                    <select name="unit">
                        <option value="g" ${unit === 'g' ? 'selected' : ''}>g (ã‚°ãƒ©ãƒ )</option>
                        <option value="ml" ${unit === 'ml' ? 'selected' : ''}>ml (ãƒŸãƒªãƒªãƒƒãƒˆãƒ«)</option>
                        <option value="å€‹" ${unit === 'å€‹' ? 'selected' : ''}>å€‹ (ã“)</option>
                    </select>
                </div>
                <div class="item-row" style="margin-top: 8px;">
                    <select name="label">
                        ${createCategoryOptions(label)}
                    </select>
                </div>
            `;
            itemInputs.appendChild(group);
        }

        function closeModal() {
            editModal.style.display = 'none';
            state.editingId = null;
            editingIdInput.value = '';
        }

        /**
         * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆä¿å­˜ï¼‰å‡¦ç†
         * â˜…å¤‰æ›´: label ã‚‚ä¿å­˜
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const store = storeInput.value;
            const date = dateInput.value;
            const editingId = editingIdInput.value; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã®ID

            // å•†å“å…¥åŠ›æ¬„ã‚’ã™ã¹ã¦å–å¾—
            const itemGroups = itemInputs.querySelectorAll('.item-group');
            
            itemGroups.forEach(group => {
                const id = group.dataset.id;
                const name = group.querySelector('[name="name"]').value;
                const price = Number(group.querySelector('[name="price"]').value);
                const quantity = Number(group.querySelector('[name="quantity"]').value);
                const unit = group.querySelector('[name="unit"]').value;
                const label = group.querySelector('[name="label"]').value; // â˜…æ–°æ©Ÿèƒ½: labelã‚’å–å¾—

                if (!name || price <= 0) return; // å•†å“åã¨ä¾¡æ ¼ã¯å¿…é ˆ

                const unitPrice = calculateUnitPrice(price, quantity);

                const product = {
                    id: (id.startsWith('new_') || !id) ? `prod_${Date.now()}_${Math.random()}` : id, // æ–°è¦ã‹æ—¢å­˜ã‹
                    name,
                    price,
                    quantity,
                    unit,
                    store,
                    date,
                    unitPrice,
                    label // â˜…æ–°æ©Ÿèƒ½: labelã‚’ä¿å­˜
                };

                // state.products ã‚’æ›´æ–°
                const existingIndex = state.products.findIndex(p => p.id === product.id);
                if (existingIndex > -1) {
                    // æ›´æ–°
                    state.products[existingIndex] = product;
                } else {
                    // æ–°è¦è¿½åŠ 
                    state.products.push(product);
                }
            });

            saveToStorage();
            renderProducts();
            closeModal();
        }

        // ======================================================
        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã¨æ¤œç´¢
        // ======================================================
        
        /**
         * æ¤œç´¢ãƒãƒ³ãƒ‰ãƒ©
         */
        function handleSearch(e) {
            state.searchQuery = e.target.value.toLowerCase();
            renderProducts();
        }

        /**
         * å•†å“ãƒªã‚¹ãƒˆã‚’å†æç”»
         */
        function renderProducts() {
            productList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

            // â˜…å¤‰æ›´: æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã®å¼·åŒ–
            // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (å•†å“å, åº—èˆ—å, â˜…ã‚«ãƒ†ã‚´ãƒªå ã§æ¤œç´¢)
            let filteredProducts = state.products;
            if (state.searchQuery) {
                filteredProducts = state.products.filter(p => {
                    const name = p.name.toLowerCase();
                    const store = p.store.toLowerCase();
                    const label = (p.label || '').toLowerCase(); // ãƒ©ãƒ™ãƒ«ãŒãªã„ãƒ‡ãƒ¼ã‚¿ã‚‚è€ƒæ…®
                    
                    return name.includes(state.searchQuery) ||
                           store.includes(state.searchQuery) ||
                           label.includes(state.searchQuery);
                });
            }

            // 2. å˜ä½ä¾¡æ ¼ã§ã‚½ãƒ¼ãƒˆ (å˜ä½ä¾¡æ ¼ãŒè¨ˆç®—ã§ãã‚‹ã‚‚ã®å„ªå…ˆã€å®‰ã„é †)
            filteredProducts.sort((a, b) => {
                const aPrice = (typeof a.unitPrice === 'number' && isFinite(a.unitPrice)) ? a.unitPrice : Infinity;
                const bPrice = (typeof b.unitPrice === 'number' && isFinite(b.unitPrice)) ? b.unitPrice : Infinity;
                if (aPrice !== bPrice) {
                    return aPrice - bPrice;
                }
                // å˜ä½ä¾¡æ ¼ãŒåŒã˜å ´åˆã¯æ—¥ä»˜ã®æ–°ã—ã„é †
                return new Date(b.date) - new Date(a.date);
            });
            
            // 3. æ¤œç´¢çµæœã®ä¸­ã§æœ€å®‰å€¤(unitPrice)ã‚’è¦‹ã¤ã‘ã‚‹ (Infinityã‚’é™¤ã)
            let cheapestPrice = Infinity;
            if (filteredProducts.length > 0) {
                 cheapestPrice = filteredProducts.reduce((min, p) => {
                    const price = (typeof p.unitPrice === 'number' && isFinite(p.unitPrice)) ? p.unitPrice : Infinity;
                    return (price < min && price !== Infinity) ? price : min;
                }, Infinity);
            }

            // 4. HTMLã‚’ç”Ÿæˆ
            if (filteredProducts.length === 0) {
                productList.innerHTML = '<p style="text-align: center; color: #777;">å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                // æœ€å®‰å€¤ã‚¯ãƒ©ã‚¹ã®ä»˜ä¸
                if (product.unitPrice === cheapestPrice && cheapestPrice !== Infinity) {
                    card.classList.add('cheapest');
                }

                const formattedDate = formatDate(product.date, 'MM/DD');
                
                let unitPriceDisplay = '';
                // â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
                if (typeof product.unitPrice === 'number' && isFinite(product.unitPrice)) {
                    unitPriceDisplay = `<span class="unit-price">${product.unitPrice.toFixed(2)}å††/${product.unit}</span>`;
                } else {
                    unitPriceDisplay = `<span class="unit-price">---</span>`;
                }

                // â˜…å¤‰æ›´: ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
                const labelDisplay = product.label ? `<span class="label">${escapeHTML(product.label)}</span>` : '';

                card.innerHTML = `
                    <div class="product-card-main">
                        <div class="product-name">${escapeHTML(product.name)}</div>
                        <div class="product-price">
                            ${product.price}å†† (${product.quantity || '?'}${product.unit}) - ${unitPriceDisplay}
                        </div>
                        <div class="product-meta">
                            ${labelDisplay}
                            <span class="store">${escapeHTML(product.store)}</span> | <span class="date">${formattedDate}</span>
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="action-button edit-button" data-id="${product.id}" title="ç·¨é›†">âœï¸</button>
                        <button class="action-button delete-button" data-id="${product.id}" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãƒœã‚¿ãƒ³ã«è¿½åŠ 
                card.querySelector('.edit-button').addEventListener('click', () => {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (å•†å“1ã¤ã ã‘)
                    showEditModal(null, product.id);
                });
                card.querySelector('.delete-button').addEventListener('click', () => {
                    if (confirm(`ã€Œ${product.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        deleteProduct(product.id);
                    }
                });

                productList.appendChild(card);
            });
        }
        
        /**
         * å•†å“ã‚’å‰Šé™¤
         */
        function deleteProduct(id) {
            state.products = state.products.filter(p => p.id !== id);
            saveToStorage();
            renderProducts();
        }

        // ======================================================
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (localStorage)
        // ======================================================
        
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.products));
        }

        function loadFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            state.products = data ? JSON.parse(data) : [];
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
         */
        function exportData() {
            if (state.products.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const json = JSON.stringify(state.products, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `priceScout_backup_${formatDate(new Date(), 'YYYYMMDD')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ======================================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ======================================================
        
        /**
         * å˜ä½ä¾¡æ ¼ã‚’è¨ˆç®—
         */
        function calculateUnitPrice(price, quantity) {
            if (typeof price === 'number' && typeof quantity === 'number' && quantity > 0) {
                return price / quantity;
            }
            return Infinity; // è¨ˆç®—ä¸èƒ½ã®å ´åˆã¯ç„¡é™å¤§ï¼ˆã‚½ãƒ¼ãƒˆã§æœ€å¾Œå°¾ï¼‰
        }

        /**
         * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (Day.js)
         */
        function formatDate(date, format = 'YYYY-MM-DD') {
            if (!date) return '';
            try {
                return dayjs(date).format(format);
            } catch (e) {
                return date; // Day.jsãŒå¤±æ•—ã—ãŸã‚‰ãã®ã¾ã¾è¿”ã™
            }
        }
        
        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }
    </script>

</body>
</html>