承知いたしました。
構成を見直し、**Gemini API にレシート画像を直接送信し、商品情報を抽出するフルAI構成** として `copilot-instructions.md` を再定義します。

この構成では、クライアントが画像ファイルをアップロードし、そのバイナリをサーバーレス関数経由で Gemini API に渡して、「商品名」「商品価格」「販売店」のみを抽出したJSONレスポンスを受け取り、アプリ側に反映します。

-----

# Copilot Instructions for PriceScout (v4 - Gemini Vision)

## このドキュメントについて

  * GitHub Copilot が本リポジトリのコンテキストを理解しやすくするためのガイドです。
  * 新しい機能を実装する際は、ここで示す技術選定・設計方針・ファイル構成を前提にしてください。
  * このプロジェクトは、Gemini API の画像理解能力を活用してレシートを直接解析する、シンプルなAI依存構成を採用します。

## 前提条件

  * 回答は必ず日本語でしてください。
  * コードの変更をする際、変更量が100行を超える可能性が高い場合は、事前に「この指示では変更量が100行を超える可能性がありますが、実行しますか？」とユーザーに確認をとるようにしてください。
  * 何か大きい変更を加える場合、まず何をするのか計画を立てた上で、ユーザーに「このような計画で進めようと思います。」と提案してください。

## アプリ概要

**PriceScout (プライススカウト)** は、レシート撮影で商品価格を記録し、過去の最安値をすぐに検索できるシンプルな価格管理アプリです。

### 主な機能

1.  **レシート撮影・AI解析登録**:
  * **Gemini Vision (サーバーレス)**: アップロードされたレシート画像をそのまま Gemini API に渡し、「商品名」「商品ごとの価格」「販売店」を JSON で抽出します。
  * **フォーム入力**: 返却されたJSONデータを `.raw-text` テキストボックスに整形して表示し、ユーザーが内容を確認・修正できるようにします。
2.  **商品価格検索**: 登録した商品名を部分一致で検索し、結果を価格の安い順に表示します。
3.  **データ管理**: 全てのデータはブラウザの `localStorage` に保存されます。JSON形式でのエクスポート・インポート機能も持ちます。

## 技術スタック概要

### クライアントサイド (ブラウザ)

  * **言語**: HTML5, CSS3, Vanilla JavaScript (ES6+)
  * **主要ライブラリ (CDN)**:
    * `Day.js`: 日付フォーマット用（必要な場合のみ）
  * **データ保存**: ブラウザの `localStorage` のみ。キー名は `priceScout_products` とします。

### サーバーサイド (APIキー隠蔽・AI処理)

  * **バックエンド (サーバーレス)**: Vercel Functions または Netlify Functions (Node.js環境)
  * **外部API (サーバーサイドで呼び出し)**:
  * **Google Gemini API**: レシート画像を解析し、商品ごとの情報を JSON として抽出

## プロジェクト構成と役割 (ディレクトリ構成)

Vercel Functions を利用する場合の構成例です。クライアントサイド3ファイル + APIエンドポイント1ファイルで構成されます。

```
/
├── api/
│   └── gemini.js  # Gemini APIを呼び出すサーバーレス関数 (唯一のAPIエンドポイント)
├── index.html     # すべてのHTML構造
├── style.css      # すべてのCSSスタイル
└── app.js         # すべてのクライアントサイド・ロジック (ファイルアップロード、APIリクエスト)
```

  * **`index.html`**: アプリのUI全体（モーダルウィンドウ含む）。
  * **`style.css`**: アプリの全スタイル。
  * **`app.js`**: 画像ファイルの検証、`api/gemini` への `FormData` 送信、返却JSONの表示・編集・保存、`localStorage` への保存、DOM操作など、クライアント側の全ロジック。
  * **`api/gemini.js`**: クライアントから画像ファイルを受け取り、Gemini API を呼び出し、整形したJSONをクライアントに返すサーバーレス関数。**Gemini APIキーはこのファイルでのみ安全に使用されます。**

## アーキテクチャ指針

### 1\. 設計原則: 画像アップロード + サーバーレスAI解析

  * クライアント (`app.js`) は、UI操作、画像アップロード、`localStorage` 管理、APIリクエストに専念します。
  * レシート解析ロジックはすべて Gemini API が担い、クライアントでの文字解析処理は行いません。
  * 取得結果の編集・確認はクライアントの `.raw-text` テキストボックスと登録済みリストで行います。

### 2\. データモデル

```javascript
// 商品オブジェクト (localStorage保存形式)
const product = {
  id: '1699459200000',      // タイムスタンプ
  name: '明治おいしい牛乳',  // Geminiが抽出した商品名
  price: 298,               // 商品ごとの価格 (税込)
  store: 'イオン鶴見店'       // Geminiが抽出した販売店
};

// 状態管理 (app.js内)
const state = {
  products: [],             // product オブジェクトの配列
  searchQuery: ''
};
```

### 3\. 画像解析フロー (Gemini Vision)

#### クライアント (app.js) の役割

1.  ユーザーがレシート画像を選択
2.  ファイルバリデーション（サイズ、形式）を実行
3.  ローディング表示などのUXケアを行う
4.  `FormData` を使って画像ファイルを `api/gemini` に送信する
5.  返却されたJSONを `.raw-text` テキストボックスへ整形して表示し、ユーザーが手動編集できるようにする
6.  ユーザーが確定させた内容を `localStorage` に保存し、登録済みリストへ反映する

#### サーバーレス関数 (api/gemini.js) の役割

1.  クライアントから `multipart/form-data` で送信された画像ファイルを受け取る
2.  Gemini のマルチモーダルモデル（例: Gemini 1.5 Flash / Gemini 1.5 Pro）に画像を直接渡す
3.  以下形式の厳密なJSONでレスポンスするようプロンプトを設計する
    ```json
    {
  "store": "イオン鶴見店",
  "items": [
    { "name": "明治おいしい牛乳", "price": 298 }
  ]
    }
    ```
4.  サーバーレス関数として、クライアントにJSONをそのまま返却する

## アンチパターン (禁止事項)

  * ❌ **APIキーのクライアントサイド保持**: `app.js` や `index.html` に Gemini のAPIキーを記述することは**絶対に禁止**します。
  * ❌ **クライアントサイドでの複雑な解析**: `app.js` でレシートテキストを正規表現や独自ルールで解析することは**禁止**します。解析はすべて `api/gemini` で行います。
  * ❌ **複雑なバックエンド/DB**: データベース（SQL/NoSQL）や、`/api/gemini` 以外の専用バックエンドサーバーの構築は禁止します。（APIキーを隠蔽するサーバーレス関数のみ許可）
  * ❌ **フレームワーク**: React, Vue, Svelte, Angular など（Vanilla JS のみ）
  * ❌ **UIライブラリ**: Bootstrap, Materialize CSS, Chakra UI など